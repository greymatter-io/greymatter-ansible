---

- name: Check if rootCA authority already exist
  shell: |
    HOME="{{ acert_home_dir }}/" /usr/local/bin/acert authorities list | grep rootCA
  register: rootCA_authority_status
  ignore_errors: yes

- name: Create  rootCA ascert authority
  shell: |
    HOME="{{ acert_home_dir }}/" /usr/local/bin/acert authorities create -n rootCA
  when: rootCA_authority_status.rc != 0

- name: Update .acert dir permissions
  file:
    path: "{{ acert_home_dir }}/.acert"
    mode: u=rwx,g=rx,o=rx
    owner: "{{ service_user }}"
    group: "{{ service_group }}"
    recurse: yes

- name: Extract rootCA authority fingerprint
  shell: |
    HOME="{{ acert_home_dir }}/" /usr/local/bin/acert authorities list | grep rootCA | sed -e 's/\s.*$//'
  register: "rootCA_fingerprint"
  when: rootCA_authority_status.rc != 0

- name: Extract rootCA authority, cert and key
  shell: |
    HOME="{{ acert_home_dir }}/" /usr/local/bin/acert authorities export "{{ rootCA_fingerprint.stdout }}" -f pem -t authority >> "{{ acert_home_dir }}"/rootCA-authority.pem
    HOME="{{ acert_home_dir }}/" /usr/local/bin/acert authorities export "{{ rootCA_fingerprint.stdout }}" -f pem -t certificate >> "{{ acert_home_dir }}"/rootCA-certificate.pem
    HOME="{{ acert_home_dir }}/" /usr/local/bin/acert authorities export "{{ rootCA_fingerprint.stdout }}" -f pem -t key >> "{{ acert_home_dir }}"/rootCA-key.pem
  when: rootCA_authority_status.rc != 0

- name: Save rootCA authority fingerprint
  shell: |
    HOME="{{ acert_home_dir }}/" /usr/local/bin/acert authorities list | grep rootCA | sed -e 's/\s.*$//' >> "{{ acert_home_dir }}"/rootCA-fingerprint
  when: rootCA_authority_status.rc != 0

- name: Compress directory {{ acert_home_dir }} into {{ acert_home_dir }}.tgz
  archive:
    path: "{{ acert_home_dir }}"
    dest: "{{ acert_home_dir }}.tgz"
  when: rootCA_authority_status.rc != 0

- name: Download rootCA authority content
  fetch:
    src: "{{ acert_home_dir }}.tgz"
    dest: roles/ansible-role-acert/files/
    flat: yes
  when: rootCA_authority_status.rc != 0